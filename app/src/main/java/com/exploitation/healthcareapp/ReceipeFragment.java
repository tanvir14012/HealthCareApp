package com.exploitation.healthcareapp;


import android.content.Context;
import android.content.Intent;
import android.graphics.Bitmap;
import android.graphics.BitmapFactory;
import android.net.Uri;
import android.os.Bundle;
import android.support.annotation.Nullable;
import android.support.v4.app.Fragment;
import android.support.v4.content.FileProvider;
import android.view.LayoutInflater;
import android.view.Menu;
import android.view.MenuInflater;
import android.view.MenuItem;
import android.view.View;
import android.view.ViewGroup;
import android.widget.ImageView;
import android.widget.TextView;
import android.widget.Toast;

import java.io.File;
import java.io.FileOutputStream;
import java.io.OutputStream;
import java.util.List;


/**
 * A simple {@link Fragment} subclass.
 */
public class ReceipeFragment extends Fragment {
    private ImageView caption;
    private TextView title,importance,description;
    private Receipe mReceipe;
    private Uri contentUri;


    public ReceipeFragment() {
        // Required empty public constructor
    }
    public static ReceipeFragment newInstance(int receipeId,int catagoryId) {

        Bundle args = new Bundle();
        args.putInt("receipeId", receipeId); //Should be erased while accessing Intent-Extra directly from fragment via getActivity().getIntent()....
        args.putInt("catagoryId",catagoryId);
        ReceipeFragment fragment = new ReceipeFragment();
        fragment.setArguments(args);
        return fragment;
    }
    public void onCreate(@Nullable Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        /*
        //This part uses Activity's Intent-Extra directly(Easy & Straight-forward)
        mReceipe = ReceipeList.getSingleReceipe( getActivity().getIntent().getStringExtra("147") ); /** Retriving value form Intent extra
         of the activity.
         I mistakenly put the above line in onCreateView(...) method & outcome was = Recyclerview was hard like Parmesan cheese **/

        //This part uses FragmentArgument
        mReceipe = ListTipsCatagory.getSingleReceipe(getArguments().getInt("catagoryId"),getArguments().getInt("receipeId"));
        setHasOptionsMenu(true);
    }

    @Override
    public void onCreateOptionsMenu(Menu menu, MenuInflater inflater) {
        inflater.inflate(R.menu.tipshare_menu,menu);
    }

    @Override
    public boolean onOptionsItemSelected(MenuItem item) {

        if(item.getItemId() == R.id.share) {
            String data = getString(getActivity().getResources().getIdentifier(mReceipe.getName(), "string", getActivity().getPackageName())) +"\n"+
                    getString(getActivity().getResources().getIdentifier(mReceipe.getDescription(), "string", getActivity().getPackageName()));
            Bitmap image = BitmapFactory.decodeResource(getActivity().getResources(), getActivity().getResources().getIdentifier(mReceipe.getCaption(),"drawable",getActivity().getPackageName()));
            File folder = new File(getContext().getFilesDir() + "/share_images");
            if(! folder.exists()) {
                folder.mkdir();
            }
            File file = new File(folder,"send.jpg");
            if(! file.exists()) {
                try{
                    file.createNewFile();
                }catch (Exception e) {
                    e.printStackTrace();
                }
            }
            FileOutputStream fout = null;
            try {
                fout = new FileOutputStream(file);
                image.compress(Bitmap.CompressFormat.JPEG,75,fout);
                fout.close();
            }catch(Exception e) {
                e.printStackTrace();
            }
            contentUri = FileProvider.getUriForFile(getContext(),"com.exploitation.healthcareapp",file);
            getContext().grantUriPermission(getContext().getPackageName(),contentUri,Intent.FLAG_GRANT_READ_URI_PERMISSION);

            Intent shareIntent = new Intent();
            shareIntent.setAction(Intent.ACTION_SEND);
            shareIntent.putExtra(Intent.EXTRA_STREAM, contentUri);
            shareIntent.setFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);
            shareIntent.putExtra(Intent.EXTRA_TEXT, data);
            shareIntent.setType("*/*");
            startActivity(Intent.createChooser(shareIntent,"Share with friends"));
        }
        return  true;
    }

    @Override
    public View onCreateView(LayoutInflater inflater, ViewGroup container,
                             Bundle savedInstanceState) {
        View view = inflater.inflate(R.layout.fragment_receipe, container, false);
        title = (TextView) view.findViewById(R.id.textView);
        importance = (TextView) view.findViewById(R.id.textView1);
        description = (TextView) view.findViewById(R.id.textView2);
        caption = (ImageView) view.findViewById(R.id.imageView);


        title.setText(getActivity().getResources().getIdentifier(mReceipe.getName(),"string",getActivity().getPackageName()));
        importance.setText(getActivity().getResources().getIdentifier(mReceipe.getImportance(),"string", getActivity().getPackageName()));
        caption.setImageResource(getActivity().getResources().getIdentifier(mReceipe.getCaption(),"drawable",getActivity().getPackageName()));
        description.setText(getActivity().getResources().getIdentifier(mReceipe.getDescription(),"string",getActivity().getPackageName()));


        return  view;
    }

    @Override
    public void onResume() {
        super.onResume();
        if(contentUri != null) {
            getContext().revokeUriPermission(contentUri, Intent.FLAG_GRANT_READ_URI_PERMISSION);
        }
    }
}
